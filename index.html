<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œìš¸ì•„ë¦¬ìˆ˜ë³¸ë¶€ AMI ì •ë°€ ì‹œë®¬ë ˆì´í„° (UI/Logic Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Pretendard', 'Noto Sans KR', sans-serif; background-color: #f1f5f9; }
        .font-mono { font-family: 'Courier New', monospace; }
        
        /* Water Stream Animation */
        .pipe-container { position: relative; height: 36px; background: #cbd5e1; border-radius: 8px; overflow: hidden; border: 2px solid #94a3b8; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .water-stream { position: absolute; top: 0; left: 0; bottom: 0; width: 100%; opacity: 0.8; }
        .stream-fwd { background: repeating-linear-gradient(45deg, #3b82f6, #3b82f6 15px, #60a5fa 15px, #60a5fa 30px); animation: flow-fwd 1s linear infinite; }
        .stream-bwd { background: repeating-linear-gradient(45deg, #ef4444, #ef4444 15px, #fca5a5 15px, #fca5a5 30px); animation: flow-bwd 1s linear infinite; }
        .stream-stop { background: #e2e8f0; }
        
        @keyframes flow-fwd { from { background-position: 0 0; } to { background-position: 42px 0; } }
        @keyframes flow-bwd { from { background-position: 0 0; } to { background-position: -42px 0; } }

        /* Packet Animation */
        .packet-path { position: relative; height: 6px; background: #cbd5e1; width: 100%; margin: 20px 0; border-radius: 3px; }
        .packet-obj { position: absolute; width: 24px; height: 24px; background: #7c3aed; border-radius: 6px; top: -9px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; opacity: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
        .anim-send { animation: send-packet 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes send-packet { 
            0% { left: 0%; opacity: 1; transform: scale(0.8); } 
            50% { transform: scale(1.2); } 
            100% { left: 95%; opacity: 0; transform: scale(0.8); } 
        }

        /* Gauge */
        .gauge-wrap { height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden; border: 1px solid #cbd5e1; margin-top: 4px; }
        .gauge-fill { height: 100%; width: 0%; transition: width 0.1s linear; }
        .gauge-fill.warning { background-color: #f59e0b; } /* Amber-500 */
        .gauge-fill.danger { background-color: #ef4444; } /* Red-500 */

        /* Custom Scroll */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }

        /* Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #ffffff; border: 2px solid currentColor; margin-top: -8px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: #cbd5e1; border-radius: 3px;
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden text-base">

    <!-- Header -->
    <header class="bg-white border-b border-slate-300 px-6 py-4 flex justify-between items-center shadow-md z-20">
        <div class="flex items-center gap-4">
            <span class="text-3xl">ğŸ’§</span>
            <div>
                <h1 class="text-2xl font-extrabold text-slate-800 tracking-tight">ì„œìš¸ì•„ë¦¬ìˆ˜ AMI ì‹œë®¬ë ˆì´í„°</h1>
                <p class="text-sm text-slate-500 font-medium">NB-IoT V2.0 (0xB1) | Digital V1.4</p>
            </div>
        </div>
        <div class="flex items-center gap-8">
            <div class="text-right border-r pr-6 border-slate-300">
                <div class="text-xs text-slate-500 font-bold mb-1">PROTOCOL</div>
                <div class="text-sm font-bold text-purple-700 bg-purple-100 px-3 py-1 rounded-md">V2.0 Active</div>
            </div>
            <div class="text-right">
                <div class="text-xs text-slate-500 font-bold mb-1">VIRTUAL TIME</div>
                <div id="clockDisplay" class="font-mono text-2xl font-bold text-blue-700 tracking-tight">0000-00-00 00:00:00</div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Left Sidebar: Controls -->
        <aside class="w-[400px] bg-white border-r border-slate-300 flex flex-col overflow-y-auto shadow-lg z-10">
            
            <!-- Time Control -->
            <div class="p-6 border-b border-slate-200">
                <div class="flex justify-between items-end mb-4">
                    <h3 class="text-sm font-bold text-slate-600 uppercase tracking-wide">âš™ï¸ ì‹œë®¬ë ˆì´ì…˜ ì†ë„</h3>
                    <span id="speedLabel" class="text-lg font-mono font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded">x1</span>
                </div>
                <input type="range" min="0" max="4" step="1" value="1" class="w-full text-blue-600 mb-2" oninput="updateSpeed(this.value)">
                <div class="flex justify-between text-xs text-slate-500 font-bold">
                    <span>ì¼ì‹œì •ì§€</span><span>x1</span><span>x60</span><span>x1H</span><span>MAX</span>
                </div>
            </div>

            <!-- Environment -->
            <div class="p-6 border-b border-slate-200 bg-slate-50">
                <h3 class="text-sm font-bold text-slate-600 uppercase mb-5 tracking-wide">ğŸŒ í™˜ê²½ ë³€ìˆ˜ ì œì–´</h3>
                
                <!-- Temp -->
                <div class="mb-6 bg-white p-4 rounded-xl border border-slate-300 shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-sm font-bold text-slate-700">ğŸŒ¡ï¸ ì˜¨ë„ (ë™íŒŒí…ŒìŠ¤íŠ¸)</label>
                        <span id="tempVal" class="text-lg font-mono font-bold text-orange-600">15 Â°C</span>
                    </div>
                    <input type="range" min="-20" max="40" value="15" class="w-full text-orange-500" oninput="updateEnv('temp', this.value)">
                    <div class="mt-3">
                        <div class="flex justify-between text-xs text-slate-500 font-bold mb-1">
                            <span>ì¡°ê±´: 0â„ƒ ì´í•˜ 1ë¶„</span>
                            <span id="stateFreeze" class="text-slate-400">ì •ìƒ</span>
                        </div>
                        <div class="gauge-wrap"><div id="gaugeFreeze" class="gauge-fill warning"></div></div>
                    </div>
                </div>

                <!-- Flow -->
                <div class="mb-6 bg-white p-4 rounded-xl border border-slate-300 shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-sm font-bold text-slate-700">ğŸš° ìœ ëŸ‰ (Q3=1600)</label>
                        <span id="flowVal" class="text-lg font-mono font-bold text-blue-600">0 L/h</span>
                    </div>
                    <input type="range" min="-2000" max="2500" value="0" step="50" class="w-full text-blue-600" oninput="updateEnv('flow', this.value)">
                    
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div>
                            <div class="flex justify-between text-xs text-slate-500 font-bold mb-1">
                                <span>ê³¼ë¶€í•˜ (5ë¶„)</span><span id="stateOver" class="text-slate-400">-</span>
                            </div>
                            <div class="gauge-wrap"><div id="gaugeOver" class="gauge-fill warning"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs text-slate-500 font-bold mb-1">
                                <span>ì—­ë¥˜ (1ë¶„)</span><span id="stateBack" class="text-slate-400">-</span>
                            </div>
                            <div class="gauge-wrap"><div id="gaugeBack" class="gauge-fill warning"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Toggles -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-3 rounded-xl border border-slate-300 shadow-sm hover:shadow-md transition">
                        <label class="flex justify-between items-center cursor-pointer mb-2">
                            <span class="text-sm font-bold text-slate-700">ğŸ§² ìì„ ê°ì§€</span>
                            <input type="checkbox" id="swMagnet" class="w-5 h-5 accent-red-600 cursor-pointer" onchange="updateEnv('magnet', this.checked)">
                        </label>
                        <div class="text-xs text-slate-400 mb-1 font-medium">ì¡°ê±´: 5ë¶„ ì§€ì†</div>
                        <div class="gauge-wrap"><div id="gaugeMag" class="gauge-fill danger"></div></div>
                    </div>
                    <div class="bg-white p-3 rounded-xl border border-slate-300 shadow-sm hover:shadow-md transition">
                        <label class="flex justify-between items-center cursor-pointer mb-2">
                            <span class="text-sm font-bold text-slate-700">ğŸ’§ ëˆ„ìˆ˜ ë°œìƒ</span>
                            <input type="checkbox" id="swLeak" class="w-5 h-5 accent-yellow-500 cursor-pointer" onchange="updateEnv('leak', this.checked)">
                        </label>
                        <div class="text-xs text-slate-400 mb-1 font-medium">ì¡°ê±´: 7ì¼ (ê°•ì œ)</div>
                        <div class="gauge-wrap"><div id="gaugeLeak" class="gauge-fill warning" style="width:0%"></div></div>
                    </div>
                </div>
            </div>

            <!-- Config -->
            <div class="p-6">
                <h3 class="text-sm font-bold text-slate-600 uppercase mb-4 tracking-wide">ğŸ“¡ ë‹¨ë§ê¸° ì„¤ì • & ìƒíƒœ</h3>
                
                <div class="mb-4 flex justify-between items-center bg-white p-3 border border-slate-300 rounded-lg">
                    <span class="text-sm font-bold text-slate-700">ğŸ”‹ ë°°í„°ë¦¬</span>
                    <input type="range" min="2.5" max="3.7" step="0.1" value="3.6" class="w-32 text-green-600" oninput="updateEnv('bat', this.value)">
                    <span id="batVal" class="text-lg font-mono font-bold text-green-600 w-16 text-right">3.6V</span>
                </div>

                <div class="mb-4 bg-white p-3 border border-slate-300 rounded-lg">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm font-bold text-slate-700">ğŸ“¶ í†µì‹  ê°ë„ (RSRP)</span>
                        <span id="rsrpVal" class="text-sm font-mono font-bold text-slate-600">-90dBm</span>
                    </div>
                    <input type="range" min="-140" max="-60" value="-90" class="w-full text-purple-600 mb-2" oninput="updateEnv('rsrp', this.value)">
                    <label class="flex items-center gap-2 text-sm cursor-pointer hover:text-red-600">
                        <input type="checkbox" id="swAckFail" class="w-4 h-4 accent-red-600" onchange="updateEnv('ackFail', this.checked)">
                        <span class="font-bold">ì„œë²„ ë¬´ì‘ë‹µ (ACK Fail í…ŒìŠ¤íŠ¸)</span>
                    </label>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 block mb-1">ê²€ì¹¨ ì£¼ê¸°</label>
                        <select id="selReadPeriod" class="w-full text-sm border-2 border-slate-300 rounded-lg p-2 font-bold focus:border-blue-500 outline-none" onchange="updateConfig()">
                            <option value="1" selected>1 ì‹œê°„</option><option value="2">2 ì‹œê°„</option>
                            <option value="4">4 ì‹œê°„</option><option value="24">24 ì‹œê°„</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 block mb-1">ë³´ê³  ì£¼ê¸°</label>
                        <select id="selReportPeriod" class="w-full text-sm border-2 border-slate-300 rounded-lg p-2 font-bold focus:border-blue-500 outline-none" onchange="updateConfig()">
                            <option value="1">1 ì‹œê°„</option><option value="6" selected>6 ì‹œê°„</option>
                            <option value="12">12 ì‹œê°„</option><option value="24">24 ì‹œê°„</option>
                        </select>
                    </div>
                </div>
                <div id="configMsg" class="text-xs text-center mb-3 font-bold text-green-600 h-4"></div>
                
                <button onclick="forceReport()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold rounded-lg shadow-md transition transform active:scale-95 flex justify-center items-center gap-2">
                    ğŸš€ ì¦‰ì‹œ ë³´ê³  (Force Report)
                </button>
            </div>
        </aside>

        <!-- Center: Visual -->
        <main class="flex-1 bg-slate-100 p-8 flex flex-col items-center justify-center relative">
            
            <!-- Weather Overlay -->
            <div class="absolute inset-0 pointer-events-none overflow-hidden">
                <div id="fxFreeze" class="hidden absolute top-8 right-8 flex flex-col items-center animate-pulse">
                    <span class="text-6xl">â„ï¸</span>
                    <span class="text-sm font-bold text-blue-600 bg-white px-3 py-1 rounded-full shadow-lg mt-2">í•œíŒŒì£¼ì˜ë³´</span>
                </div>
            </div>

            <!-- Pipeline Visual -->
            <div class="w-full max-w-4xl flex items-center mb-20 relative">
                <div class="w-16 h-10 bg-slate-400 rounded-l flex items-center justify-center text-xs font-bold text-white shadow-md">ì…ìˆ˜</div>
                <div class="flex-1 pipe-container"><div id="waterStream1" class="water-stream stream-stop"></div></div>
                
                <!-- Digital Meter -->
                <div class="relative z-10 w-72 bg-white rounded-2xl shadow-2xl border-2 border-slate-300 p-5 flex flex-col items-center mx-[-4px]">
                    <div class="w-full flex justify-between items-center mb-3 border-b border-slate-200 pb-2">
                        <span class="text-xs font-black text-slate-500 tracking-wider">DIGITAL METER V1.4</span>
                        <span class="text-xs text-slate-400 font-mono font-bold">ID:11223344</span>
                    </div>
                    <div class="w-full bg-emerald-50 border-2 border-emerald-100 rounded-xl p-4 mb-4 text-right shadow-inner">
                        <span id="meterReadout" class="font-mono text-4xl font-black text-emerald-800 tracking-wider">00000.000</span>
                        <span class="text-lg text-emerald-600 font-bold ml-1">mÂ³</span>
                    </div>
                    <div class="w-full flex justify-between items-center h-10">
                        <div class="w-10 h-10 rounded-full border-4 border-slate-200 flex items-center justify-center bg-slate-50 shadow-inner">
                            <div id="meterSpinner" class="text-xl grayscale opacity-30">âš™ï¸</div>
                        </div>
                        <div id="meterStatusIcons" class="flex gap-2 text-2xl"></div>
                    </div>
                    <div class="absolute -right-8 top-1/2 w-8 h-2 bg-gray-800 rounded-full shadow-sm"></div>
                </div>

                <div class="flex-1 pipe-container"><div id="waterStream2" class="water-stream stream-stop"></div></div>
                <div class="w-16 h-10 bg-slate-400 rounded-r flex items-center justify-center text-xs font-bold text-white shadow-md">ì¶œìˆ˜</div>
            </div>

            <!-- Terminal (Modem) -->
            <div class="flex flex-col items-center relative transform scale-110">
                <div class="h-16 w-2 bg-gray-800 shadow-sm"></div>
                <div class="w-64 bg-slate-800 rounded-2xl shadow-2xl p-6 text-white border-t-8 border-blue-500 relative">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="text-sm font-extrabold text-slate-200 tracking-wide">SMART TERMINAL</div>
                            <div class="text-xs text-slate-500 font-mono font-bold">NB-IoT Model-S</div>
                        </div>
                        <div class="flex gap-2">
                            <div id="ledPwr" class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]" title="Power"></div>
                            <div id="ledTx" class="w-3 h-3 rounded-full bg-slate-600" title="TX/RX"></div>
                        </div>
                    </div>
                    
                    <div class="bg-black/40 rounded-xl p-3 text-center mb-4 border border-slate-600 backdrop-blur-sm shadow-inner">
                        <div id="modemState" class="font-mono text-2xl font-bold text-yellow-400 tracking-widest drop-shadow-md">SLEEP</div>
                        <div class="text-xs text-slate-400 mt-2 flex justify-center gap-2 font-medium">
                            <span>Next Report: <span id="nextTimeDisplay" class="text-white font-bold">--:--</span></span>
                        </div>
                    </div>

                    <div class="flex justify-between items-end text-xs text-slate-400 font-bold">
                        <div class="flex items-center gap-1.5"><span id="signalIcon" class="text-base">ğŸ“¶</span><span id="modemRsrp">-90dBm</span></div>
                        <div id="modemBatText" class="font-mono text-base text-green-400">3.6V</div>
                    </div>

                    <!-- Buffer Gauge -->
                    <div class="absolute top-[-36px] left-0 w-full flex justify-center">
                        <div class="bg-slate-700 text-white px-4 py-1.5 rounded-full shadow-lg border-2 border-slate-600 flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-300">ğŸ“¦ Buffer:</span>
                            <span id="bufferCountDisplay" class="font-mono text-base font-bold text-blue-300">0</span>
                            <span class="text-xs text-slate-500">/ 24</span>
                        </div>
                    </div>

                    <!-- Alerts -->
                    <div id="modemAlerts" class="absolute -top-20 -right-36 w-36 flex flex-col gap-2 items-start"></div>
                </div>
                
                <!-- Packet Path -->
                <div class="packet-path w-64 absolute left-full top-1/2 ml-10 hidden lg:block">
                    <div class="absolute -top-7 text-xs text-slate-400 w-full text-center font-bold tracking-wide">NB-IoT Network</div>
                    <div id="packetObj" class="packet-obj">ğŸ“¦</div>
                </div>
            </div>

            <!-- Server -->
            <div class="absolute right-12 top-1/2 -translate-y-1/2 hidden lg:flex flex-col items-center opacity-90 scale-110">
                <div class="w-28 h-32 bg-indigo-900 rounded-xl shadow-2xl border-b-8 border-indigo-950 p-4 flex flex-col justify-center gap-3">
                    <div class="w-full h-2 bg-indigo-800 rounded-full overflow-hidden"><div class="h-full w-1/2 bg-indigo-400 animate-pulse"></div></div>
                    <div class="w-full h-2 bg-indigo-800 rounded-full overflow-hidden"><div class="h-full w-3/4 bg-indigo-400 animate-pulse" style="animation-delay:0.2s"></div></div>
                    <div class="w-full h-2 bg-indigo-800 rounded-full overflow-hidden"><div class="h-full w-1/3 bg-indigo-400 animate-pulse" style="animation-delay:0.4s"></div></div>
                </div>
                <div class="mt-3 text-sm font-black text-indigo-900 tracking-wider">AMI SERVER</div>
            </div>
        </main>

        <!-- Right Sidebar: Log -->
        <aside class="w-[500px] bg-white border-l border-slate-300 flex flex-col z-10 shadow-lg">
            <div class="flex border-b border-slate-300 text-sm font-bold text-slate-500 bg-white">
                <button onclick="uiLogTab('sys')" id="tabSys" class="flex-1 py-4 text-center border-b-4 border-blue-600 text-blue-800 bg-blue-50 transition">System Log</button>
                <button onclick="uiLogTab('pkt')" id="tabPkt" class="flex-1 py-4 text-center hover:bg-slate-50 transition text-slate-500">Packet Log</button>
            </div>
            
            <div class="px-4 py-2 flex justify-between items-center bg-slate-50 border-b border-slate-200">
                 <span class="text-xs font-bold text-slate-400">REAL-TIME MONITOR</span>
                 <button onclick="clearLogs()" class="text-xs font-bold text-gray-400 hover:text-red-600 underline transition-colors">CLEAR LOGS</button>
            </div>

            <!-- Log Content -->
            <div id="logContainer" class="flex-1 overflow-y-auto p-5 font-mono text-xs text-slate-700 custom-scroll leading-relaxed bg-white">
                <div class="text-blue-600 font-bold mb-3 p-2 bg-blue-50 rounded">--- System Ready (V2.0 Core) ---</div>
            </div>
            <div id="packetContainer" class="hidden flex-1 overflow-y-auto p-5 font-mono text-xs text-slate-800 custom-scroll whitespace-pre leading-relaxed select-all bg-slate-50"></div>
            
            <!-- Debug Info -->
            <div class="h-52 border-t border-slate-300 bg-slate-100 p-5 overflow-y-auto text-xs font-mono">
                <h4 class="font-bold text-slate-500 mb-3 uppercase tracking-wider flex items-center gap-2">
                    <span>ğŸ› ï¸ Internal Memory</span>
                    <span class="text-[10px] bg-slate-200 px-1 rounded">Debug</span>
                </h4>
                <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-slate-600">
                    <div class="flex justify-between border-b border-slate-200 pb-1"><span>Total Usage:</span> <span id="dbgUsage" class="font-bold text-blue-600">0.000</span></div>
                    <div class="flex justify-between border-b border-slate-200 pb-1"><span>Buffer Size:</span> <span id="dbgBuf" class="font-bold">0</span></div>
                    <div class="flex justify-between border-b border-slate-200 pb-1"><span>Retry Count:</span> <span id="dbgRetry" class="font-bold text-red-500">0</span></div>
                    <div class="flex justify-between border-b border-slate-200 pb-1"><span>Send Timer:</span> <span id="dbgTimer">0</span></div>
                    <div class="flex justify-between border-b border-slate-200 pb-1" title="Digital V1.4 Status 1"><span>Status 1 (Hex):</span> <span id="dbgSt1" class="font-bold text-purple-600">00</span></div>
                    <div class="flex justify-between border-b border-slate-200 pb-1" title="Digital V1.4 Status 2"><span>Status 2 (Hex):</span> <span id="dbgSt2" class="font-bold text-purple-600">00</span></div>
                </div>
            </div>
        </aside>

    </div>

    <!-- Core Logic -->
    <script>
        // Utilities
        const pad = (n,w) => (n+'').padStart(w,'0');
        const toHex = (n) => (n<0 ? (0xFF+n+1) : n).toString(16).toUpperCase().padStart(2,'0');
        const nowStr = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1,2)}-${pad(d.getDate(),2)} ${pad(d.getHours(),2)}:${pad(d.getMinutes(),2)}:${pad(d.getSeconds(),2)}`;

        // State
        const state = {
            running: true, speed: 1, time: new Date().getTime(), lastTick: Date.now(),
            temp: 15, flow: 0, volt: 3.6, magnet: false, leak: false, rsrp: -90, ackFail: false,
            usage: 123.456, alarms: { freeze:0, magnet:0, overload:0, backflow:0 },
            thresholds: { freeze:60000, magnet:300000, overload:300000, backflow:60000 },
            progress: { freeze:0, magnet:0, overload:0, backflow:0 },
            mode: "SLEEP", readPeriod: 3600000, reportPeriod: 21600000, // 1h, 6h
            nextRead: 0, nextReport: 0, buffer: [], retryCount: 0, forceReport: false,
            delayTimer: 0, lastAlarmState: { m:false, f:false }, pendingSentCount: 0
        };

        // Align Start Time to Report Period to ensure Full Packet (User Request)
        // If report is 6h, align start time to 0, 6, 12, 18.
        const alignHour = 6 * 3600000;
        const alignedStart = Math.ceil(state.time / alignHour) * alignHour;
        state.time = alignedStart; // Start at exact report boundary (e.g., 18:00)
        state.nextRead = state.time + state.readPeriod; 
        state.nextReport = state.time + state.reportPeriod; 
        
        // Loop
        function loop() {
            if(!state.running) return requestAnimationFrame(loop);
            const now = Date.now();
            const realDelta = (now - state.lastTick);
            state.lastTick = now;
            const speedMap = [0, 1, 60, 3600, 86400];
            const virtualDeltaMs = realDelta * speedMap[state.speed];
            
            if(state.speed > 0) {
                state.time += virtualDeltaMs;
                updateMeter(virtualDeltaMs);
                updateModemLogic(virtualDeltaMs);
            }
            updateUI();
            requestAnimationFrame(loop);
        }
        requestAnimationFrame(loop);

        function updateMeter(dtMs) {
            if(state.flow !== 0) state.usage += (state.flow / 3600000000) * dtMs;
            updateTimer('freeze', state.temp <= 0, dtMs);
            updateTimer('overload', state.flow > 1600, dtMs);
            updateTimer('backflow', state.flow < 0, dtMs);
            updateTimer('magnet', state.magnet, dtMs);
        }
        function updateTimer(key, cond, ms) {
            const th = state.thresholds[key];
            if(cond) {
                if(state.alarms[key] < th) {
                    state.alarms[key] += ms;
                    if(state.alarms[key] >= th) sysLog(`[METER] ${key.toUpperCase()} ê²½ë³´ ë°œìƒ!`, 'alarm');
                }
            } else state.alarms[key] = 0;
            state.progress[key] = Math.min(100, (state.alarms[key] / th) * 100);
        }

        // --- Synchronous Modem Logic (Fixes Buffer Bug) ---
        function updateModemLogic(dtMs) {
            // Event Check
            const isMag = state.alarms.magnet >= state.thresholds.magnet;
            const isFrz = state.alarms.freeze >= state.thresholds.freeze;
            if ((isMag && !state.lastAlarmState.m) || (isFrz && !state.lastAlarmState.f)) {
                sysLog(`[MODEM] ê¸´ê¸‰ ì´ë²¤íŠ¸ -> ì¦‰ì‹œ ë³´ê³ `, 'alarm');
                state.mode = "WAKE"; state.forceReport = true;
            }
            state.lastAlarmState = { m: isMag, f: isFrz };

            if(state.delayTimer > 0) {
                state.delayTimer -= dtMs;
                return;
            }

            switch(state.mode) {
                case "SLEEP":
                    if (state.time >= state.nextRead) state.mode = "WAKE";
                    break;
                case "WAKE":
                    state.mode = "READ";
                    break;
                case "READ":
                    // Read Data & Add to Buffer
                    state.buffer.push({ 
                        time: state.nextRead, val: state.usage, st1: getStatus1(), st2: getStatus2() 
                    });
                    sysLog(`[METER] ê²€ì¹¨ ì €ì¥ (${state.buffer.length})`, 'meter');
                    
                    state.nextRead += state.readPeriod;
                    
                    // Check Report
                    if (state.time >= state.nextReport || state.forceReport) {
                        state.mode = "CONNECT";
                    } else {
                        state.mode = "SLEEP";
                    }
                    break;
                case "CONNECT":
                    // Visual Delay (Simulate modem boot/connect)
                    state.delayTimer = 500 * (state.speed===1?1:0); 
                    state.mode = "SEND";
                    break;
                case "SEND":
                    // Determine how many to send (Max 24)
                    state.pendingSentCount = Math.min(state.buffer.length, 24);
                    
                    const pkt = buildPacket(state.pendingSentCount);
                    const fmtPkt = pkt.match(/.{1,2}/g).join(' ');
                    sysLog(`[TX] 1 Packet Sent (Contains ${state.pendingSentCount} Readings)`, 'tx');
                    packetLog(fmtPkt);
                    animPacket();
                    
                    if(!state.forceReport) state.nextReport += state.reportPeriod;
                    state.forceReport = false;
                    
                    state.delayTimer = 500 * (state.speed===1?1:0);
                    state.mode = "WAIT";
                    break;
                case "WAIT":
                    if (state.ackFail) {
                        state.retryCount++;
                        sysLog(`[NET] ACK ì‹¤íŒ¨ (Retry ${state.retryCount})`, 'err');
                        if(state.retryCount >= 3) {
                            sysLog(`[MODEM] ì „ì†¡ í¬ê¸°. ë°ì´í„° ë³´ê´€. Sleep`, 'err');
                            state.retryCount = 0;
                            state.mode = "SLEEP";
                        } else {
                            state.mode = "CONNECT"; 
                        }
                    } else {
                        sysLog(`[RX] ACK ìˆ˜ì‹  (RSRP ${state.rsrp}dBm)`, 'rx');
                        // *** CRITICAL FIX: Clear buffer ONLY on ACK ***
                        if(state.pendingSentCount > 0) {
                            state.buffer.splice(0, state.pendingSentCount); 
                            state.pendingSentCount = 0;
                        }
                        state.retryCount = 0;
                        state.mode = "SLEEP";
                    }
                    break;
            }
        }

        // Helpers
        function getStatus1() {
            let b = 0;
            if(state.alarms.overload >= state.thresholds.overload) b |= 0x80;
            if(state.alarms.backflow >= state.thresholds.backflow) b |= 0x40;
            if(state.leak) b |= 0x20;
            let bc = 0;
            if(state.volt < 3.7) {
                if(state.volt < 0.7) bc = 31; else bc = Math.floor((3.7 - state.volt) * 10) + 1;
                if(bc > 31) bc = 31;
            }
            b |= (bc & 0x1F);
            return b;
        }
        function getStatus2() {
            let b = 0;
            if(state.alarms.magnet >= state.thresholds.magnet) b |= 0x80;
            if(state.alarms.freeze >= state.thresholds.freeze) b |= 0x40;
            b |= 0x08; b |= 3; return b;
        }
        function buildPacket(cnt) {
            const p = [0xB1, 0x00, 0x70];
            pushBCD(p, "861921031229508F"); pushBCD(p, "450012345678901F");
            p.push(85, 0, 0,0,0,0, 0, Math.abs(state.rsrp), 0,0, 0xFC,0xFF);
            pushBCD(p, "0001234501"); p.push(0x02, 0x00, Math.round(state.volt * 10));
            pushBCD(p, "11223344"); p.push(0x02, 0x13);
            let s = 0;
            if(state.alarms.overload >= state.thresholds.overload) s |= 0x80;
            if(state.alarms.backflow >= state.thresholds.backflow) s |= 0x40;
            if(state.leak) s |= 0x20;
            if(state.alarms.magnet >= state.thresholds.magnet) s |= 0x10;
            if(state.alarms.freeze >= state.thresholds.freeze) s |= 0x08;
            p.push(s, 0x53);
            let t = Math.round(state.temp); if(t < 0) t = 256 + t;
            p.push(t & 0xFF, 0, 0, 0, 0x01, state.readPeriod/3600000, state.reportPeriod/3600000);
            const d = new Date(state.time);
            p.push(d.getFullYear()-2000, d.getMonth()+1, d.getDate(), d.getHours(), d.getMinutes(), d.getSeconds());
            p.push(0x01, cnt, 0x00);
            if(cnt > 0) {
                const lat = state.buffer[cnt-1];
                const r = Math.round(lat.val * 1000);
                p.push(r&0xFF, (r>>8)&0xFF, (r>>16)&0xFF, (r>>24)&0xFF);
                for(let i=1; i<cnt; i++) {
                    const prev = state.buffer[cnt - 1 - i];
                    const v = Math.round(prev.val * 1000);
                    p.push(v&0xFF, (v>>8)&0xFF, (v>>16)&0xFF, (v>>24)&0xFF);
                }
            } else p.push(0,0,0,0);
            p[1] = p.length + 1;
            let sum = 0; for(let i=1; i<p.length; i++) sum += p[i];
            p.push(sum & 0xFF);
            return p.map(b => b.toString(16).toUpperCase().padStart(2,'0')).join('');
        }
        function pushBCD(arr, str) { for(let i=0; i<str.length; i+=2) arr.push(parseInt(str.substr(i,2), 16)); }

        // UI Handlers
        function updateUI() {
            document.getElementById('clockDisplay').innerText = nowStr(new Date(state.time));
            document.getElementById('meterReadout').innerText = pad(state.usage.toFixed(3), 9);
            const ws1=document.getElementById('waterStream1'), ws2=document.getElementById('waterStream2'), sp=document.getElementById('meterSpinner');
            if(state.flow===0) { ws1.className=ws2.className="water-stream stream-stop"; sp.style.animationPlayState="paused"; }
            else if(state.flow>0) { ws1.className=ws2.className="water-stream stream-fwd"; sp.style.animationPlayState="running"; sp.style.animationDirection="normal"; }
            else { ws1.className=ws2.className="water-stream stream-bwd"; sp.style.animationPlayState="running"; sp.style.animationDirection="reverse"; }
            
            setGauge('gaugeFreeze', state.progress.freeze, 'stateFreeze', state.alarms.freeze >= state.thresholds.freeze);
            setGauge('gaugeOver', state.progress.overload, 'stateOver', state.alarms.overload >= state.thresholds.overload);
            setGauge('gaugeBack', state.progress.backflow, 'stateBack', state.alarms.backflow >= state.thresholds.backflow);
            setGauge('gaugeMag', state.progress.magnet, null, state.alarms.magnet >= state.thresholds.magnet);
            const gl = document.getElementById('gaugeLeak'); gl.style.width=state.leak?"100%":"0%"; gl.className=state.leak?"gauge-fill warning":"gauge-fill";
            
            const stD = document.getElementById('modemState'); stD.innerText = state.mode; stD.className = `font-mono text-2xl font-bold ${state.mode==='SLEEP'?'text-gray-400':'text-yellow-400'}`;
            document.getElementById('nextTimeDisplay').innerText = new Date(state.nextReport).toLocaleTimeString();
            document.getElementById('modemRsrp').innerText = state.rsrp + "dBm";
            document.getElementById('modemBatText').innerText = state.volt + "V";
            document.getElementById('bufferCountDisplay').innerText = state.buffer.length;
            
            let al = "";
            if(state.alarms.freeze >= state.thresholds.freeze) al += `<div class="bg-blue-500 text-white text-[10px] px-2 py-1 rounded shadow mb-1">â„ï¸ ë™íŒŒ</div>`;
            if(state.alarms.magnet >= state.thresholds.magnet) al += `<div class="bg-red-500 text-white text-[10px] px-2 py-1 rounded shadow mb-1">ğŸ§² ìì„</div>`;
            if(state.leak) al += `<div class="bg-yellow-500 text-white text-[10px] px-2 py-1 rounded shadow mb-1">ğŸ’§ ëˆ„ìˆ˜</div>`;
            document.getElementById('modemAlerts').innerHTML = al;
            
            document.getElementById('dbgUsage').innerText = state.usage.toFixed(3);
            document.getElementById('dbgBuf').innerText = state.buffer.length;
            document.getElementById('dbgRetry').innerText = state.retryCount;
            document.getElementById('dbgTimer').innerText = Math.round(state.delayTimer);
            document.getElementById('dbgSt1').innerText = "0x" + toHex(getStatus1());
            document.getElementById('dbgSt2').innerText = "0x" + toHex(getStatus2());
        }
        function setGauge(id, pct, txtId, trig) {
            document.getElementById(id).style.width = pct + "%";
            document.getElementById(id).className = `gauge-fill ${trig ? 'danger' : 'warning'}`;
            if(txtId) { const t = document.getElementById(txtId); t.innerText = trig ? "ë°œìƒ" : (pct>0?"ê°ì§€ì¤‘":"-"); t.className = trig ? "text-red-500 font-bold" : "text-slate-400"; }
        }
        function animPacket() { const d=document.getElementById('packetObj'); d.classList.remove('anim-send'); void d.offsetWidth; d.classList.add('anim-send'); }
        function sysLog(msg, type) {
            const b = document.getElementById('logContainer'); const d = document.createElement('div');
            let c = "text-slate-600";
            if(type==='tx') c="text-purple-600 font-bold"; if(type==='rx') c="text-green-600 font-bold"; if(type==='err') c="text-red-600 font-bold";
            if(type==='alarm') c="text-red-500 font-bold bg-red-50 px-1 rounded inline-block";
            d.innerHTML = `<span class="text-[10px] text-slate-400 mr-2">[${new Date(state.time).toLocaleTimeString()}]</span><span class="${c}">${msg}</span>`;
            d.className = "mb-2 border-b border-slate-100 pb-1"; b.appendChild(d); b.scrollTop = b.scrollHeight;
        }
        function packetLog(rawHex) {
            const box = document.getElementById('packetContainer'); const row = document.createElement('div');
            row.innerHTML = `<span class="text-blue-600 font-bold mr-4 select-none">${nowStr(new Date(state.time))}</span><span>${rawHex}</span>`;
            row.className = "mb-2 border-b border-gray-200 pb-2 font-mono text-xs hover:bg-slate-100 transition";
            box.appendChild(row); box.scrollTop = box.scrollHeight;
        }
        function uiLogTab(t) {
            const sys = document.getElementById('logContainer'), pkt = document.getElementById('packetContainer');
            const bS = document.getElementById('tabSys'), bP = document.getElementById('tabPkt');
            if(t==='sys') {
                sys.classList.remove('hidden'); pkt.classList.add('hidden');
                bS.className = "flex-1 py-4 text-center border-b-4 border-blue-600 text-blue-800 bg-blue-50 font-bold transition";
                bP.className = "flex-1 py-4 text-center hover:bg-slate-50 text-slate-500 transition";
            } else {
                sys.classList.add('hidden'); pkt.classList.remove('hidden');
                bS.className = "flex-1 py-4 text-center hover:bg-slate-50 text-slate-500 transition";
                bP.className = "flex-1 py-4 text-center border-b-4 border-purple-600 text-purple-800 bg-purple-50 font-bold transition";
            }
        }
        function updateSpeed(v) { state.speed=parseInt(v); document.getElementById('speedLabel').innerText=["ì¼ì‹œì •ì§€","x1","x60","x1H","MAX"][v]; }
        function updateEnv(k, v) {
            if(k==='flow') { state.flow=parseInt(v); document.getElementById('flowVal').innerText=v+" L/h"; }
            if(k==='temp') { state.temp=parseInt(v); document.getElementById('tempVal').innerText=v+" Â°C"; }
            if(k==='bat') { state.volt=parseFloat(v); document.getElementById('batVal').innerText=v+"V"; }
            if(k==='magnet') state.magnet=v; if(k==='leak') state.leak=v;
            if(k==='rsrp') { state.rsrp=parseInt(v); document.getElementById('rsrpVal').innerText=v+"dBm"; }
            if(k==='ackFail') state.ackFail=v;
        }
        function updateConfig() {
            const rd=parseInt(document.getElementById('selReadPeriod').value), rp=parseInt(document.getElementById('selReportPeriod').value);
            const m=document.getElementById('configMsg');
            if(rp < rd) { m.innerText="âš  ì˜¤ë¥˜: ë³´ê³ ì£¼ê¸° < ê²€ì¹¨ì£¼ê¸°"; m.className="text-xs text-center mb-3 font-bold text-red-500 h-4"; return; }
            m.innerText="ì„¤ì • ë³€ê²½ ì™„ë£Œ"; m.className="text-xs text-center mb-3 font-bold text-green-600 h-4";
            state.readPeriod=rd*3600000; state.reportPeriod=rp*3600000;
            state.nextRead=state.time+state.readPeriod; state.nextReport=state.time+state.reportPeriod;
            sysLog(`[CONFIG] ê²€ì¹¨${rd}H / ë³´ê³ ${rp}H ë³€ê²½`, 'info');
        }
        function forceReport() { state.forceReport=true; if(state.mode==='SLEEP') { sysLog(`[USER] ê°•ì œ ë³´ê³  ì‹¤í–‰`, 'info'); } }
        function clearLogs() { document.getElementById('logContainer').innerHTML='<div class="text-blue-600 font-bold mb-3 p-2 bg-blue-50 rounded">--- System Ready ---</div>'; document.getElementById('packetContainer').innerHTML=''; }
    </script>
</body>
</html>